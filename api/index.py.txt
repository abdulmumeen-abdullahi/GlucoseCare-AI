from fastapi import FastAPI
from pydantic import BaseModel
from glucosecare.agent import app, ensure_state, memory

app_api = FastAPI()

class UserMessage(BaseModel):
    message: str
    thread_id: str | None = None

@app_api.post("/chat")
def chat(payload: UserMessage):
    state = ensure_state({})
    state["input"] = payload.message
    thread_id = payload.thread_id or "default"

    new_state = app.invoke(
        state,
        config={"configurable": {"thread_id": thread_id}},
        checkpointer=memory
    )
    return {"response": new_state.get("output", "No response.")}
